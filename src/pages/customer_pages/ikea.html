<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ikea - Customer Page</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="../customer_page_style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
</head>
<body>
<div class="proof-container">
        <div class="logo-area">
            <!-- Company Logo -->
            <img src="images/company_logo.png" alt="Company Logo">
        </div>
              <div class="company-contact-info">
              <p class="company-tel">Tel: 0333 456 1501</p>
              <p class="company-email">Email: sales@tbsg.co.uk</p>
            </div>

        <div class="header">
            <h1>Ikea</h1>

        </div>

        <div class="horizontal-line-top"></div>  <!-- Top Horizontal Line -->


        <div class="garment-details">
            <p>[GARMENT_CODE]</p>
            <p>[PROOF_DESCRIPTION]</p>
        </div>

        <div class="image-grid">
            <div class="image-box" id="proof-image-1">
                <!-- Proof Image 1 Placeholder -->
            </div>
            <div class="image-box-stack">
              <div class="image-box" id="proof-image-2">
                  <!-- Proof Image 2 Placeholder -->
              </div>
              <div class="image-box" id="proof-image-3">
                  <!-- Proof Image 3 Placeholder -->
              </div>
            </div>
        </div>



        <div class="footer">
            <p>107 Longmead Road Emerald Park East Emersons Green Bristol BS16 7FG</p>
            <p>tbsg.co.uk</p>
             <p>Positional Guide only</p>
        </div>
    </div>

    <div id="upload-proof-modal-1" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeProofModal(1)">Ã—</span>
            <h2>Upload Proof for Ikea</h2>
            <form id="upload-proof-form-1" onsubmit="return false;">
                <input type="file" id="proof-upload-input" name="proof-upload-input" accept=".pdf" required>
                <input type="text" id="proof-garment-code" name="garmentCode" placeholder="Garment Code" required>
                <input type="text" id="proof-logo" name="logo" placeholder="Logo" required>
                <input type="text" id="proof-logo-position" name="logoPosition" placeholder="Logo Position" required>
                <textarea id="proof-description" name="proofDescription" placeholder="Optional Description"></textarea>
                <button type="button" onclick="handleProofUpload(1)">Upload Proof</button>
            </form>
        </div>
    </div>
    <script>
        async function deleteLogo(customerId, logoIndex) {
             console.log(`Attempting to delete logo at index ${logoIndex} for customer ID ${customerId}`);

            const confirmDelete = confirm("Are you sure you want to delete this logo?");
            if (!confirmDelete) {
                console.log('Delete logo cancelled by user.');
                return; // Stop if user cancels
            }

            try {
                const response = await fetch(`/api/customers/${customerId}/logos/${logoIndex}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    const message = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${message.error}`);
                }

                const result = await response.json();
                console.log('Logo deleted successfully:', result);

                alert(result.message); // Show success message

                // Remove the logo item from the DOM (customer page)
                const logoItemToDelete = document.querySelector(`.logo-item button.delete-logo-button[data-logo-index="${logoIndex}"]`).closest('.logo-item');
                if (logoItemToDelete) {
                    logoItemToDelete.remove();
                }
            } catch (error) {
                console.error('Error deleting logo:', error);
                alert(`Failed to delete logo: ${error.message}`);
            }
        }
    </script><script>
    async function deleteCustomer(customerId) {
            console.log(`Attempting to delete customer with ID: ${customerId}`);

            const confirmDelete = confirm("Are you REALLY sure you want to delete this customer?\nThis action cannot be undone and will delete all customer data including logos and threads!");
            if (!confirmDelete) {
                console.log('Customer deletion cancelled by user.');
                return; // Stop if user cancels
            }

            try {
                const response = await fetch(`/api/customers/${customerId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const message = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${message.error}`);
                }

                const result = await response.json();
                console.log('Customer deleted successfully:', result);
                alert(result.message); // Show success message

                // Redirect back to the home page after successful deletion
                window.location.href = '/index.html';


            } catch (error) {
                console.error('Error deleting customer:', error);
                alert(`Failed to delete customer: ${error.message}`);
            }
        }
    </script><script>
function createProofTableRow(proof, index, customerId) { // Add customerId parameter
        return `
        <tr data-proof-index="${index}">
        <td><a href="${proof.url}" target="_blank">View Proof</a></td>
          <td>${proof.garmentCode}</td>
          <td>${proof.logo}</td>
          <td>${proof.logoPosition}</td>
          <td>${proof.description || 'N/A'}</td>
           <td>
                <button class="delete-proof-button" onclick="handleProofDelete(${customerId}, ${index})">Delete</button>
            </td>
        </tr>
      `;
    }
    </script><script>
async function handleProofUpload(customerId) {
    console.log(`handleProofUpload called for customer ID: ${customerId}`);
    const fileInput = document.getElementById('proof-upload-input'); // NO customer-specific ID
    const garmentCodeInput = document.getElementById('proof-garment-code');
    const logoInput = document.getElementById('proof-logo');
    const logoPositionInput = document.getElementById('proof-logo-position');
    const descriptionInput = document.getElementById('proof-description');

    const file = fileInput.files[0];
    const garmentCode = garmentCodeInput.value.trim();
    const logo = logoInput.value.trim();
    const logoPosition = logoPositionInput.value.trim();
    const proofDescription = descriptionInput.value.trim();

    if (!file) {
        alert('Please select a PDF file to upload.');
        return;
    }

    if (!garmentCode || !logo || !logoPosition) {
        alert('Please fill in Garment Code, Logo, and Logo Position.');
        return;
    }

    const formData = new FormData();
    formData.append('proof-upload-input', file);
    formData.append('garmentCode', garmentCode);
    formData.append('logo', logo);
    formData.append('logoPosition', logoPosition);
    formData.append('proofDescription', proofDescription);

    const proofsTableBody = document.querySelector('#proofs-table tbody'); // Get tbody

    try {
        const response = await fetch(`/api/customers/${customerId}/proofs`, {
            method: 'PUT',
            body: formData,
        });
        const result = await response.json();
        if (response.ok) {
            alert(result.message);
            fileInput.value = '';
            garmentCodeInput.value = '';
            logoInput.value = '';
            logoPositionInput.value = '';
            descriptionInput.value = '';
            console.log("proof details", result.proof);

            // Add the new proof to the table *on the current page*:
            const newRow = createProofTableRow(result.proof, proofsTableBody.rows.length, customerId); // Corrected index
            proofsTableBody.insertAdjacentHTML('beforeend', newRow); // Add to the end

            closeProofModal(customerId); // Close the modal

        } else {
            const message = await response.json();
            throw new Error(message.error || 'Failed to upload proof.');
        }

    }
    catch (error) {
        console.error('Error uploading proof:', error);
        alert(error.message);
    }
}
</script><script>
        async function handleProofDelete(customerId, proofIndex) {
          console.log(`handleProofDelete called for customer ID: ${customerId}, and proof index: ${proofIndex} `);
          if (!confirm('Are you sure you want to delete this proof?')) {
                return;
            }

            try {
                const response = await fetch(`/api/customers/${customerId}/proofs/${proofIndex}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    const message = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${message.error}`);
                }
                const result = await response.json();
                console.log('Proof deleted successfully:', result);
                alert(result.message);

                // Find and remove the table row
                const rowToDelete = document.querySelector(`#proofs-table tbody tr[data-proof-index="${proofIndex}"]`);
                if (rowToDelete) {
                    rowToDelete.remove();
                }
            } catch (error) {
                    console.error('Error deleting proof:', error);
                alert(`Failed to delete proof: ${error.message}`);
           }
        }
    </script><script>
       function openProofModal(customerId) {
            const modal = document.getElementById(`upload-proof-modal-${customerId}`);
             if (modal) {
                modal.style.display = 'block';
                console.log(`upload-proof-modal-${customerId} opened`)
             } else {
                console.error('Modal not found for customer ID:', customerId);
             }

        }

        function closeProofModal(customerId) {
            const modal = document.getElementById(`upload-proof-modal-${customerId}`);
            if (modal) {
            modal.style.display = 'none';
           }
        }
    </script><script src="../proof_creator.js"></script></body>
</html>